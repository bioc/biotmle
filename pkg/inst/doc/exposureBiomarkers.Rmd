---
title: "Identifying Biomarkers from an Exposure Variable"
author: "Nima S. Hejazi & Alan E. Hubbard"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Identifying Biomarkers from an Exposure Variable}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup_data}
library(dplyr)
library(biotmle)
data(illumina2007)
"%ni%" = Negate("%in%")

data <- illumina2007 %>%
  dplyr::select(which(colnames(.) %ni% c("box", "riboaveugml", "ng", "exclude",
                                         "hyb", "totalrnaug", "chip", "Chip.Id",
                                         "Chip.Section", "label.c", "benzene",
                                         "illumID", "berkeley_vial_label",
                                         "cRNA"))) %>%
  dplyr::filter(!duplicated(.$id)) %>%
  dplyr::mutate(
    benzene = I(newbenz),
    smoking = I(current_smoking)
  ) %>%
  dplyr::select(which(colnames(.) %ni% c("newbenz", "current_smoking")))

subjIDs <- data$id
```

```{r clean_data}
# W - age, sex, smoking
W <- data %>%
  dplyr::select(which(colnames(.) %in% c("age", "sex", "smoking"))) %>%
  dplyr::mutate(
    age = as.numeric((age > quantile(age, 0.25))),
    sex = I(sex),
    smoking = I(smoking)
  )


# A - benzene exposure (discretized)
A <- data %>%
  dplyr::select(which(colnames(.) %in% c("benzene")))
A <- A[, 1]


# Y - genes
Y <- data %>%
  dplyr::select(which(colnames(.) %ni% c("age", "sex", "smoking", "benzene",
                                         "id")))

geneIDs <- colnames(Y)
```

The following procedure takes a long time to run, so rather than run it as part
of this vignette, we provide the necessary syntax:
```{r biomarkerTMLE_eval, eval=FALSE}
biomarkerTMLEout <- biomarkertmle(Y = Y,
                                  W = W,
                                  A = A,
                                  type = "exposure",
                                  family = "gaussian",
                                  g_lib = c("SL.glmnet", "SL.randomForest",
                                            "SL.nnet", "SL.polymars",
                                            "SL.mean"),
                                  Q_lib = c("SL.glmnet", "SL.randomForest",
                                            "SL.nnet", "SL.mean")
                                 )
```

A `data.frame` object containing the results of this procedure is included with
the package and will be used for the remainder of this vignette:
```{r load_biomarkerTMLE_result, eval=FALSE}
data(illumina2007result)
```

```{r limmaTMLE_eval, eval=FALSE}
design <- as.data.frame(cbind(rep(1, nrow(Y)),
                              as.numeric(A == max(unique(A)))))
colnames(design) <- c("intercept", "Tx")

limmaTMLEout <- limmatmle(biotmle, IDs = NULL, designMat = design)
```

```{r heatmap_limma_results, eval=FALSE}
heatmap_biotmle(biotmle, designMat = design, FDRcutoff = 0.05, top = 25)
```

```{r pval_hist_limma_results, eval=FALSE}
plot_biotmle(biotmle, type = "pvals_raw")

plot_biotmle(biotmle, type = "pvals_adj")
```

```{r volcano_plot_limma_results, eval=FALSE}
volcplot_biotmle(biotmle)
```
